{{! ============================================
    B√öSQUEDA DE HECHOS - HEADER
    ============================================ }}
{{#partial "contenido-header"}}
  {{#if esRegistrado}}
    <span>üë§ {{username}}</span>
    {{#if esAdmin}}
      <a href="/dashboard" class="link-primary">Panel Admin</a>
    {{/if}}
    <a href="/logout" class="link-danger">Cerrar sesi√≥n</a>
  {{else}}
    <a href="/login" class="link-primary">Iniciar sesi√≥n</a>
    <a href="/register" class="link-primary">Registrarse</a>
  {{/if}}
{{/partial}}

{{! ============================================
    B√öSQUEDA DE HECHOS - CONTENIDO PRINCIPAL
    ============================================ }}
{{#partial "contenido"}}

  {{! --- Secci√≥n de B√∫squeda --- }}
  <div class="search-section mb-4">
    <h1 class="mb-3 text-center">üîç B√∫squeda de Hechos</h1>
    <p class="text-center text-muted mb-4">Encuentra hechos hist√≥ricos por t√≠tulo, categor√≠a, ubicaci√≥n o fecha</p>

    {{! --- Formulario de B√∫squeda --- }}
    <form action="/hechos/buscar" method="GET" class="search-form">

      {{! --- Grid de Campos de B√∫squeda --- }}
      <div class="form-grid">

        {{! Campo: T√≠tulo }}
        <div class="form-group">
          <label for="titulo">T√≠tulo</label>
          <input type="text" name="titulo" id="titulo"
                 placeholder="Buscar por t√≠tulo..."
                 value="{{filtros.titulo}}">
        </div>

        {{! Campo: Categor√≠a }}
        <div class="form-group">
          <label for="categoria">Categor√≠a</label>
          <input type="text" name="categoria" id="categoria"
                 placeholder="Ej: Incendios, Accidentes..."
                 value="{{filtros.categoria}}">
        </div>

        {{! Campo: Descripci√≥n }}
        <div class="form-group">
          <label for="descripcion">Descripci√≥n</label>
          <input type="text" name="descripcion" id="descripcion"
                 placeholder="Palabras clave..."
                 value="{{filtros.descripcion}}">
        </div>

        {{! Campo: Provincia }}
        <div class="form-group">
          <label for="provincia">Provincia</label>
          <input type="text" name="provincia" id="provincia"
                 placeholder="Ej: Buenos Aires, CABA..."
                 value="{{filtros.provincia}}">
        </div>

        {{! Campo: Latitud }}
        <div class="form-group">
          <label for="latitud">Latitud (opcional)</label>
          <input type="number" step="0.0001" name="latitud" id="latitud"
                 placeholder="-34.6037"
                 value="{{filtros.latitud}}">
        </div>

        {{! Campo: Longitud }}
        <div class="form-group">
          <label for="longitud">Longitud (opcional)</label>
          <input type="number" step="0.0001" name="longitud" id="longitud"
                 placeholder="-58.3816"
                 value="{{filtros.longitud}}">
        </div>

        {{! Campo: Fecha del Acontecimiento }}
        <div class="form-group">
          <label for="fechaAcontecimiento">Fecha del Hecho</label>
          <input type="date" name="fechaAcontecimiento" id="fechaAcontecimiento"
                 value="{{filtros.fechaAcontecimiento}}">
        </div>

        {{! Campo: Fecha de Carga }}
        <div class="form-group">
          <label for="fechaCarga">Fecha de Carga</label>
          <input type="date" name="fechaCarga" id="fechaCarga"
                 value="{{filtros.fechaCarga}}">
        </div>

        {{! Campo: Fecha Desde }}
        <div class="form-group">
          <label for="fechaDesde">Desde</label>
          <input type="date" name="fechaDesde" id="fechaDesde"
                 value="{{filtros.fechaDesde}}">
        </div>

        {{! Campo: Fecha Hasta }}
        <div class="form-group">
          <label for="fechaHasta">Hasta</label>
          <input type="date" name="fechaHasta" id="fechaHasta"
                 value="{{filtros.fechaHasta}}">
        </div>
      </div>

      {{! --- Botones de Acci√≥n --- }}
      <div class="form-actions text-center mt-4">
        <button type="submit" class="btn btn-search-primary">
          üîç Buscar Hechos
        </button>
        <button type="button" class="btn btn-limpiar" onclick="limpiarFormulario()">
          üóëÔ∏è Limpiar
        </button>
      </div>
    </form>
  </div>

  {{! ============================================
      SECCI√ìN DE RESULTADOS
      ============================================ }}
  {{#if resultadosBusqueda}}
    <div class="results-section">

      {{! --- Encabezado de Resultados con Controles de Vista --- }}
      <div class="results-header d-flex justify-content-between align-items-center flex-wrap mb-3">
        <h2>Resultados: <span class="badge bg-primary">{{cantidadResultados}}</span></h2>

        {{! --- Controles de Vista (Lista/Mapa) --- }}
        <div class="view-controls">
          <button class="btn btn-sm btn-outline-primary active" data-view="lista" onclick="cambiarVista('lista')">
            üìã Lista
          </button>
          <button class="btn btn-sm btn-outline-primary" data-view="mapa" onclick="cambiarVista('mapa')">
            üó∫Ô∏è Mapa
          </button>
        </div>
      </div>

      {{! --- Vista de Lista de Hechos --- }}
      {{#if hechos}}
        {{! Vista en Formato de Tarjetas (Grid) }}
        <div id="vista-lista" class="view-container">
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {{#each hechos}}
              <div class="col">
                {{! Tarjeta Individual de Hecho }}
                <div class="card shadow-sm h-100 d-flex flex-column">

                  <div class="card-body flex-grow-1 d-flex flex-column">

                    <h5 class="card-title mb-2">{{this.titulo}}</h5>

                    <p class="card-text text-muted flex-grow-1">
                      {{this.descripcion}}
                    </p>

                    {{!-- CTA est√°tico abajo --}}
                    <div class="mt-3 text-end">
                      <a href="/hechos/{{this.id}}" class="btn btn-ver-hecho">
                        üëÅÔ∏è Ver hecho
                      </a>
                    </div>

                  </div>

                  {{!-- Footer con fecha y solicitud --}}
                  <div class="card-footer text-end">
                    <a href="/hechos/{{this.id}}/solicitud" class="btn btn-sm btn-delete-request mt-2">
                      üóëÔ∏è Solicitar Eliminaci√≥n
                    </a>
                  </div>
                </div>
              </div>
            {{/each}}
          </div>
        </div>

        {{! Vista de Mapa Interactivo }}
        <div id="vista-mapa" class="view-container mt-4" style="display: none;">
          <div id="map" style="height: 65vh;" class="rounded shadow"></div>
          <p class="text-muted text-center mt-2">üìç Haz clic en los marcadores para ver detalles</p>
        </div>
      {{else}}
        {{! Mensaje cuando no hay resultados }}
        <div class="alert alert-warning text-center">
          üòî No se encontraron hechos con los criterios especificados.<br>
          <button class="btn btn-outline-secondary mt-2" onclick="limpiarFormulario()">
            Limpiar filtros
          </button>
        </div>
      {{/if}}
    </div>
  {{/if}}

  {{! ============================================
      SCRIPTS
      ============================================ }}

  {{! Librer√≠a Leaflet para Mapas }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    {{! ==========================================
        Funci√≥n: Limpiar Formulario
        ========================================== }}
    function limpiarFormulario() {
      document.querySelectorAll('.search-form input').forEach(input => input.value = '');
      window.location.href = '/hechos/buscar';
    }

    {{! ==========================================
        Funci√≥n: Cambiar Vista (Lista/Mapa)
        ========================================== }}
    function cambiarVista(vista) {
      // Actualizar botones activos
      document.querySelectorAll('[data-view]').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-view="${vista}"]`).classList.add('active');

      // Ocultar todas las vistas y mostrar la seleccionada
      document.querySelectorAll('.view-container').forEach(c => c.style.display = 'none');
      document.getElementById(`vista-${vista}`).style.display = 'block';

      // Inicializar mapa si se selecciona
      if (vista === 'mapa') inicializarMapa();
    }

    {{! ==========================================
        Funci√≥n: Inicializar Mapa de Leaflet
        ========================================== }}
    let mapaInicializado = false;
    function inicializarMapa() {
      if (mapaInicializado) return;

      // Array de hechos desde el servidor
      const hechos = [
        {{#each hechos}}
        {
          titulo: "{{this.titulo}}",
          descripcion: "{{this.descripcion}}",
          categoria: "{{this.categoria}}",
          latitud: {{this.latitud}},
          longitud: {{this.longitud}},
          fechaAcontecimiento: "{{formatDate this.fechaAcontecimiento}}",
          id: {{this.id}}
        }{{#unless @last}},{{/unless}}
        {{/each}}
      ];

      if (hechos.length === 0) return;

      // Calcular centro promedio
      const latProm = hechos.reduce((s, h) => s + h.latitud, 0) / hechos.length;
      const lonProm = hechos.reduce((s, h) => s + h.longitud, 0) / hechos.length;

      // Inicializar mapa
      const mapa = L.map('map').setView([latProm, lonProm], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(mapa);

      // Agregar marcadores
      hechos.forEach(h => {
        L.marker([h.latitud, h.longitud])
          .addTo(mapa)
          .bindPopup(`<h6>${h.titulo}</h6>
                      <p>${h.descripcion}</p>
                      <small>üìÖ ${h.fechaAcontecimiento}</small><br>
                      <a href="/hechos/${h.id}/solicitud" class="btn btn-sm btn-outline-danger mt-1">Eliminar</a>`);
      });

      mapaInicializado = true;
    }
  </script>
{{/partial}}

{{> templates/layout}}
